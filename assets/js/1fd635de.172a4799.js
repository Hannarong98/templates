"use strict";(self.webpackChunkdocusaurus=self.webpackChunkdocusaurus||[]).push([[326],{3905:function(e,t,n){n.d(t,{Zo:function(){return d},kt:function(){return m}});var a=n(7294);function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){i(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,a,i=function(e,t){if(null==e)return{};var n,a,i={},r=Object.keys(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||(i[n]=e[n]);return i}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(i[n]=e[n])}return i}var p=a.createContext({}),l=function(e){var t=a.useContext(p),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},d=function(e){var t=l(e.components);return a.createElement(p.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},c=a.forwardRef((function(e,t){var n=e.components,i=e.mdxType,r=e.originalType,p=e.parentName,d=s(e,["components","mdxType","originalType","parentName"]),c=l(n),m=i,g=c["".concat(p,".").concat(m)]||c[m]||u[m]||r;return n?a.createElement(g,o(o({ref:t},d),{},{components:n})):a.createElement(g,o({ref:t},d))}));function m(e,t){var n=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var r=n.length,o=new Array(r);o[0]=c;var s={};for(var p in t)hasOwnProperty.call(t,p)&&(s[p]=t[p]);s.originalType=e,s.mdxType="string"==typeof e?e:i,o[1]=s;for(var l=2;l<r;l++)o[l]=n[l];return a.createElement.apply(null,o)}return a.createElement.apply(null,n)}c.displayName="MDXCreateElement"},2367:function(e,t,n){n.r(t),n.d(t,{frontMatter:function(){return s},contentTitle:function(){return p},metadata:function(){return l},toc:function(){return d},default:function(){return c}});var a=n(7462),i=n(3366),r=(n(7294),n(3905)),o=["components"],s={title:"AAD Authorization",sidebar_position:2},p=void 0,l={unversionedId:"setup/authorization",id:"setup/authorization",isDocsHomePage:!1,title:"AAD Authorization",description:"The example code is set up to use authorization. For this to work, an App Registration has to be set up in Azure AD.",source:"@site/dotnet/setup/authorization.mdx",sourceDirName:"setup",slug:"/setup/authorization",permalink:"/dotnet/setup/authorization",editUrl:"https://github.com/Intility/templates/tree/main/docusaurus/dotnet/setup/authorization.mdx",version:"current",sidebarPosition:2,frontMatter:{title:"AAD Authorization",sidebar_position:2},sidebar:"cra",previous:{title:"GitLab Repository",permalink:"/dotnet/setup/gitlab"},next:{title:".gitlab-ci.yml Overview",permalink:"/dotnet/setup/gitlab-ci"}},d=[{value:"API",id:"api",children:[]},{value:"Add an application scope",id:"add-an-application-scope",children:[]},{value:"Swagger",id:"swagger",children:[{value:"Adding reply URLs",id:"adding-reply-urls",children:[]},{value:"Access API",id:"access-api",children:[]}]},{value:"Guest users",id:"guest-users",children:[]}],u={toc:d};function c(e){var t=e.components,s=(0,i.Z)(e,o);return(0,r.kt)("wrapper",(0,a.Z)({},u,s,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("p",null,"The example code is set up to use authorization. For this to work, an App Registration has to be set up in Azure AD."),(0,r.kt)("h3",{id:"api"},"API"),(0,r.kt)("p",null,"Head over to ",(0,r.kt)("a",{parentName:"p",href:"https://portal.azure.com/#blade/Microsoft_AAD_IAM/ActiveDirectoryMenuBlade/RegisteredApps"},"Azure -> Azure Active Directory -> App registrations"),"\nwith your Intility Account, and create a new registration."),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"New Registration in Azure",src:n(5137).Z}),(0,r.kt)("br",{parentName:"p"}),"\n","Select a fitting name for your project, this name will be presented to the user during consent."),(0,r.kt)("p",null,"Under ",(0,r.kt)("inlineCode",{parentName:"p"},"Supported account types"),", choose either ",(0,r.kt)("inlineCode",{parentName:"p"},"Intility AS only - Single tenant")," or ",(0,r.kt)("inlineCode",{parentName:"p"},"Any Azure AD directory - Multitenant"),".\nThis can be changed later, so if you're unsure what to choose, select single tenant."),(0,r.kt)("p",null,"Under ",(0,r.kt)("inlineCode",{parentName:"p"},"Redirect URI"),", select ",(0,r.kt)("inlineCode",{parentName:"p"},"Web")," from the dropdown, and enter ",(0,r.kt)("inlineCode",{parentName:"p"},"http://localhost:5000"),"."),(0,r.kt)("p",null,"Hit the register button, and you will be taken to an overview of your newly created registration."),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"Finding Client ID",src:n(3768).Z}),(0,r.kt)("br",{parentName:"p"}),"\n","Copy the ",(0,r.kt)("inlineCode",{parentName:"p"},"Application (Client) ID")," GUID, and paste it into the ",(0,r.kt)("inlineCode",{parentName:"p"},"AzureAd:ClientId")," field in your ",(0,r.kt)("inlineCode",{parentName:"p"},"appsettings.json")," file."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-jsx",metastring:'title="appsettings.json"',title:'"appsettings.json"'},'{\n  "AzureAd": {\n    "ClientId": "YOUR_CLIENT_ID",\n    ...\n  },\n  ...\n}\n')),(0,r.kt)("div",{className:"admonition admonition-info alert alert--info"},(0,r.kt)("div",{parentName:"div",className:"admonition-heading"},(0,r.kt)("h5",{parentName:"div"},(0,r.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,r.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,r.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"}))),"info")),(0,r.kt)("div",{parentName:"div",className:"admonition-content"},(0,r.kt)("p",{parentName:"div"},"If you chose Multitenant, set the ",(0,r.kt)("inlineCode",{parentName:"p"},"AzureAd:TenantId")," field to ",(0,r.kt)("inlineCode",{parentName:"p"},"common"),"."))),(0,r.kt)("h3",{id:"add-an-application-scope"},"Add an application scope"),(0,r.kt)("p",null,"Go to Expose an API in your app registration, and add a scope.\nYou will be prompted to set an Application ID URI.\nUse the suggested one, and hit Save and continue."),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"Add a scope",src:n(1667).Z})),(0,r.kt)("p",null,"Add a scope named ",(0,r.kt)("inlineCode",{parentName:"p"},"user_impersonation"),", that can be consented by ",(0,r.kt)("inlineCode",{parentName:"p"},"Admins and users"),"."),(0,r.kt)("p",null,"You can use the following descriptions:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"Access API as user\nAllows the app to access the API as the user.\n\nAccess API as you\nAllows the app to acces the API as you.\n")),(0,r.kt)("h2",{id:"swagger"},"Swagger"),(0,r.kt)("p",null,"In addition to creating an App Registration for the API itself, we need to make one for the Swagger client too.\nAgain head over to ",(0,r.kt)("a",{parentName:"p",href:"https://portal.azure.com/#blade/Microsoft_AAD_IAM/ActiveDirectoryMenuBlade/RegisteredApps"},"Azure -> Azure Active Directory -> App registrations"),"."),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"New Registration in Azure",src:n(8080).Z}),"  "),(0,r.kt)("p",null,"Use the same name appended with ",(0,r.kt)("inlineCode",{parentName:"p"},"Swagger"),"."),(0,r.kt)("p",null,"Under ",(0,r.kt)("inlineCode",{parentName:"p"},"Redirect URI"),", select ",(0,r.kt)("inlineCode",{parentName:"p"},"Single-page application (SPA)")," and enter ",(0,r.kt)("inlineCode",{parentName:"p"},"http://localhost:5000/oauth2-redirect.html"),"."),(0,r.kt)("p",null,"Hit the register button, and you will be taken to an overview of your newly created registration."),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"Finding Client ID",src:n(8995).Z}),(0,r.kt)("br",{parentName:"p"}),"\n","Copy the ",(0,r.kt)("inlineCode",{parentName:"p"},"Application (Client) ID")," GUID, and paste it into the ",(0,r.kt)("inlineCode",{parentName:"p"},"AzureAd:ClientId")," field in your ",(0,r.kt)("inlineCode",{parentName:"p"},"appsettings.json")," file."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-jsx",metastring:'title="appsettings.json"',title:'"appsettings.json"'},'{\n  "Swagger": {\n    "ClientId": "YOUR_SWAGGER_CLIENT_ID",\n    ...\n  },\n  ...\n}\n')),(0,r.kt)("h3",{id:"adding-reply-urls"},"Adding reply URLs"),(0,r.kt)("p",null,"For each deployment of your app, you'll need to register it. You can do that by going to the Authentication page."),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"Adding Reply URLs",src:n(9244).Z}),(0,r.kt)("br",{parentName:"p"}),"\n","The first reply URLs we need to add are the localhost https URL, and the OpenShift deploy URL:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"https://localhost:5001/oauth2-redirect.html\nhttps://{your-project-slug}-dev.apps.int.intility.no/oauth2-redirect.html\n")),(0,r.kt)("p",null,"You can also add more later if you create more environments."),(0,r.kt)("h3",{id:"access-api"},"Access API"),(0,r.kt)("p",null,"To allow Swagger to talk to the API, you need to add API permissions to the Swagger app registration.\nGo to API permissions, and hit Add a permission.\nUnder My APIs, find your API, select the scope(s) and press Add permissions."),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"Add API permission",src:n(4302).Z})),(0,r.kt)("h2",{id:"guest-users"},"Guest users"),(0,r.kt)("p",null,"The template comes with an authorization policy that denies guest users in Azure AD from accessing the API.\nThis policy is enabled when the application is not set up as multitenant.\nIf you want guest users to access your single tenant API, simply remove the lines applying the policy."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-csharp",metastring:"title=Startup.cs",title:"Startup.cs"},'services.AddAuthorization(options =>\n{\n    var tenantId = Configuration["AzureAd:TenantId"];\n    if (tenantId != "common" && tenantId != "organizations")\n    {\n        options.AddPolicy("NoGuests", policy => policy.RequireClaim(\n            ClaimConstants.TenantId,\n            tenantId));\n    }\n});\n')))}c.isMDXComponent=!0},1667:function(e,t,n){t.Z=n.p+"assets/images/azure-add-scope-1b8457ba1e65c5e9f719f6ce5d8f2509.png"},4302:function(e,t,n){t.Z=n.p+"assets/images/azure-api-permissions-3bfc9e8d1623d4e3030cdc7b31ee9872.png"},3768:function(e,t,n){t.Z=n.p+"assets/images/azure-clientid-dotnet-a31cd0017a15663e6474390653500747.png"},8995:function(e,t,n){t.Z=n.p+"assets/images/azure-clientid-swagger-aeffd261b413bda085518af4de06fb52.png"},5137:function(e,t,n){t.Z=n.p+"assets/images/azure-new-dotnet-d9fb3917e0d9dba0f782fba6c7b5d64f.png"},8080:function(e,t,n){t.Z=n.p+"assets/images/azure-new-swagger-f585ee6da48bc30d279999fb080ddcb3.png"},9244:function(e,t,n){t.Z=n.p+"assets/images/azure-replyurls-swagger-a9471812a200512d52bd05df1f221d87.png"}}]);